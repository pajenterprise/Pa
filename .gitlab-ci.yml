".agent_build_common_deb":
  "artifacts": &id010
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR"
  "script": &id011
  - "echo \"About to build for $RELEASE_VERSION\""
  - "rm -rf $OMNIBUS_PACKAGE_DIR/*"
  - "$S3_CP_CMD $S3_ARTIFACTS_URI/system-probe.${PACKAGE_ARCH} /tmp/system-probe"
  - "chmod 755 /tmp/system-probe"
  - "inv -e agent.omnibus-build --release-version \"$RELEASE_VERSION\" --major-version\
    \ \"$AGENT_MAJOR_VERSION\" --python-runtimes \"$PYTHON_RUNTIMES\" --base-dir $OMNIBUS_BASE_DIR\
    \ ${USE_S3_CACHING} --skip-deps --system-probe-bin=/tmp/system-probe --no-with-bcc"
  - "$S3_CP_CMD $OMNIBUS_BASE_DIR/pkg/datadog-agent_*_${PACKAGE_ARCH}.deb $S3_ARTIFACTS_URI/$DESTINATION_DEB"
  - "$S3_CP_CMD $OMNIBUS_BASE_DIR/pkg/datadog-agent-dbg_*_${PACKAGE_ARCH}.deb $S3_ARTIFACTS_URI/$DESTINATION_DBG_DEB"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/datadog-agent*_${PACKAGE_ARCH}.deb{,.metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR"
".agent_build_common_rpm":
  "artifacts": &id012
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR"
  "script": &id013
  - "echo \"About to build for $RELEASE_VERSION\""
  - "rm -rf $OMNIBUS_PACKAGE_DIR/*"
  - "set +x"
  - "RPM_GPG_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.rpm_signing_private_key_e09422b3\
    \ --with-decryption --query \"Parameter.Value\" --out text)"
  - "printf -- \"$RPM_GPG_KEY\" | gpg --import --batch"
  - "export RPM_SIGNING_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.rpm_signing_key_passphrase_e09422b3 --with-decryption --query\
    \ \"Parameter.Value\" --out text)"
  - "set -x"
  - "$S3_CP_CMD $S3_ARTIFACTS_URI/system-probe.${PACKAGE_ARCH} /tmp/system-probe"
  - "chmod 755 /tmp/system-probe"
  - "inv -e agent.omnibus-build --release-version \"$RELEASE_VERSION\" --major-version\
    \ \"$AGENT_MAJOR_VERSION\" --python-runtimes \"$PYTHON_RUNTIMES\" --base-dir $OMNIBUS_BASE_DIR\
    \  ${USE_S3_CACHING} --skip-deps --system-probe-bin=/tmp/system-probe --no-with-bcc"
  - "find $OMNIBUS_BASE_DIR/pkg -type f -name '*.rpm' ! -name '*dbg*.rpm' -print0\
    \ | xargs -0 -I '{}' rpm -i '{}'"
  - "find $OMNIBUS_BASE_DIR/pkg -type f -name '*dbg*.rpm' -print0 | xargs -0 -I '{}'\
    \ rpm -i '{}'"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/*.{rpm,metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR"
".agent_build_common_suse_rpm":
  "artifacts": &id014
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR_SUSE"
  "script": &id015
  - "echo \"About to build for $RELEASE_VERSION\""
  - "rm -rf $OMNIBUS_PACKAGE_DIR_SUSE/*"
  - "set +x"
  - "RPM_GPG_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.rpm_signing_private_key_e09422b3\
    \ --with-decryption --query \"Parameter.Value\" --out text)"
  - "printf -- \"$RPM_GPG_KEY\" | gpg --import --batch"
  - "export RPM_SIGNING_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.rpm_signing_key_passphrase_e09422b3 --with-decryption --query\
    \ \"Parameter.Value\" --out text)"
  - "set -x"
  - "$S3_CP_CMD $S3_ARTIFACTS_URI/system-probe.${PACKAGE_ARCH} /tmp/system-probe"
  - "chmod 755 /tmp/system-probe"
  - "inv -e agent.omnibus-build --release-version \"$RELEASE_VERSION\" --major-version\
    \ \"$AGENT_MAJOR_VERSION\" --python-runtimes \"$PYTHON_RUNTIMES\" --base-dir $OMNIBUS_BASE_DIR_SUSE\
    \ ${USE_S3_CACHING} --skip-deps --system-probe-bin=/tmp/system-probe --no-with-bcc"
  - "find $OMNIBUS_BASE_DIR_SUSE/pkg -type f -name '*.rpm' ! -name '*dbg*.rpm' -print0\
    \ | xargs -0 -I '{}' zypper in '{}'"
  - "find $OMNIBUS_BASE_DIR_SUSE/pkg -type f -name '*dbg*.rpm' -print0 | xargs -0\
    \ -I '{}' zypper in '{}'"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR_SUSE && cp $OMNIBUS_BASE_DIR_SUSE/pkg/*.{rpm,metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR_SUSE"
".agent_with-bcc_build_common_deb":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR"
  "script":
  - "echo \"About to build for $RELEASE_VERSION\""
  - "rm -rf $OMNIBUS_PACKAGE_DIR/*"
  - "$S3_CP_CMD $S3_ARTIFACTS_URI/system-probe.with-bcc.${PACKAGE_ARCH} /tmp/system-probe"
  - "chmod 755 /tmp/system-probe"
  - "$S3_CP_CMD $S3_ARTIFACTS_URI/libbcc-${PACKAGE_ARCH}.tar.xz /tmp/libbcc.tar.xz"
  - "inv -e agent.omnibus-build --release-version \"$RELEASE_VERSION\" --major-version\
    \ \"$AGENT_MAJOR_VERSION\" --python-runtimes \"$PYTHON_RUNTIMES\" --base-dir $OMNIBUS_BASE_DIR\
    \ ${USE_S3_CACHING} --skip-deps --system-probe-bin=/tmp/system-probe --libbcc-tarball=/tmp/libbcc.tar.xz"
  - "$S3_CP_CMD $OMNIBUS_BASE_DIR/pkg/datadog-agent_*_${PACKAGE_ARCH}.deb $S3_ARTIFACTS_URI/$DESTINATION_DEB"
  - "$S3_CP_CMD $OMNIBUS_BASE_DIR/pkg/datadog-agent-dbg_*_${PACKAGE_ARCH}.deb $S3_ARTIFACTS_URI/$DESTINATION_DBG_DEB"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/datadog-agent*_${PACKAGE_ARCH}.deb{,.metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR"
".build_libbcc_common":
  "needs": []
  "script":
  - "git clone -b \"$BCC_VERSION\" --depth=1 https://github.com/iovisor/bcc.git /tmp/bcc"
  - "mkdir /tmp/bcc/build"
  - "cd /tmp/bcc/build"
  - "cmake .. -DCMAKE_INSTALL_PREFIX=/opt/libbcc -DCMAKE_EXE_LINKER_FLAGS='-Wl,-rpath,/opt/datadog-agent/embedded/lib'\
    \ -DCMAKE_SHARED_LINKER_FLAGS='-Wl,-rpath,/opt/datadog-agent/embedded/lib'"
  - "make -j 4"
  - "make install"
  - "cd /opt/libbcc"
  - "chmod go-rwx lib/libbcc*"
  - "rm share/bcc/introspection/bps"
  - "cp $(ldd lib/libbcc.so | awk '$1 ~ /^libtinfo/ {system(\"dirname \" $3)}')/libtinfo*\
    \ lib"
  - "tar cvaf /tmp/libbcc.tar.xz ."
  - "$S3_CP_CMD /tmp/libbcc.tar.xz $S3_ARTIFACTS_URI/libbcc-$ARCH.tar.xz"
  "stage": "deps_build"
".docker_build_job_definition_amd64":
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:v1907756-26d65dc-18.09.6"
  "tags":
  - "runner:docker"
  - "size:large"
  "variables":
    "ARCH": "amd64"
".docker_build_job_definition_arm64":
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:v1903032-53399bc-18.09.6-arm64"
  "tags":
  - "runner:docker-arm"
  - "platform:arm64"
  "variables":
    "ARCH": "arm64"
".docker_hub_variables":
  "DELEGATION_KEY_SSM_KEY": "docker_hub_signing_key"
  "DELEGATION_PASS_SSM_KEY": "docker_hub_signing_pass"
  "DOCKER_REGISTRY_LOGIN_SSM_KEY": "docker_hub_login"
  "DOCKER_REGISTRY_PWD_SSM_KEY": "docker_hub_pwd"
  "DOCKER_REGISTRY_URL": "docker.io"
  "SRC_AGENT": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/agent"
  "SRC_DCA": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/cluster-agent"
  "SRC_DSD": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/dogstatsd"
".kitchen_agent_a6":
  "artifacts": &id001
    "expire_in": "2 weeks"
    "paths":
    - "$CI_PROJECT_DIR/kitchen_logs"
    "when": "always"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": &id002
  - "runner:main"
  - "size:large"
  "variables": &id004
    "AGENT_MAJOR_VERSION": !!int "6"
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a6"
".kitchen_agent_a7":
  "artifacts": *id001
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": &id005
    "AGENT_MAJOR_VERSION": !!int "7"
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a7"
".kitchen_cleanup_azure_common":
  "allow_failure": !!bool "true"
  "before_script": &id024
  - "rsync -azr --delete ./ $SRC_PATH"
  "dependencies": &id025 []
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "script": &id026
  - "cd $DD_AGENT_TESTING_DIR"
  - "bash -l tasks/clean.sh"
  "stage": "testkitchen_cleanup"
  "tags": &id027
  - "runner:main"
  - "size:large"
  "when": "always"
".kitchen_cleanup_s3_common":
  "allow_failure": !!bool "true"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS"
  "script": &id028
  - "aws s3 rm s3://$DEB_TESTING_S3_BUCKET/dists/pipeline-$DD_PIPELINE_ID --recursive"
  - "aws s3 rm s3://$RPM_TESTING_S3_BUCKET/pipeline-$DD_PIPELINE_ID --recursive"
  - "aws s3 rm s3://$RPM_TESTING_S3_BUCKET/suse/pipeline-$DD_PIPELINE_ID --recursive"
  - "if [ $AGENT_MAJOR_VERSION == \"7\" ]; then export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A7;\
    \ else export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A6; fi"
  - "aws s3 rm s3://$WIN_S3_BUCKET/$WINDOWS_TESTING_S3_BUCKET --recursive"
  - "cd $OMNIBUS_PACKAGE_DIR"
  - "for deb in $(ls *amd64.deb); do aws s3 rm s3://$DEB_TESTING_S3_BUCKET/pool/d/da/$deb\
    \ --recursive; done"
  "stage": "testkitchen_cleanup"
  "tags": &id029
  - "runner:main"
  - "size:large"
  "when": "always"
".kitchen_common":
  "artifacts": *id001
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
".kitchen_os_centos":
  "before_script": &id003
  - "rsync -azr --delete ./ $SRC_PATH"
  - "export TEST_PLATFORMS=\"centos-69,urn,OpenLogic:CentOS:6.9:6.9.20180530\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|centos-77,urn,OpenLogic:CentOS:7.7:7.7.201912090\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|rhel-81,urn,RedHat:RHEL:8.1:8.1.2020020415\""
  - "cd $DD_AGENT_TESTING_DIR"
  - "bash -l tasks/kitchen_setup.sh"
".kitchen_os_debian":
  "before_script": &id006
  - "rsync -azr --delete ./ $SRC_PATH"
  - "export TEST_PLATFORMS=\"debian-8,urn,credativ:Debian:8:8.20190313.0\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|debian-9,urn,credativ:Debian:9:9.20190515.0\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|debian-10,urn,Debian:debian-10:10:0.20190709.401\""
  - "cd $DD_AGENT_TESTING_DIR"
  - "bash -l tasks/kitchen_setup.sh"
".kitchen_os_suse":
  "before_script": &id007
  - "rsync -azr --delete ./ $SRC_PATH"
  - "export TEST_PLATFORMS=\"sles-11,urn,SUSE:SLES-BYOS:11-SP4:2019.12.05\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|sles-12,urn,SUSE:SLES-BYOS:12-SP4:2019.11.13\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|sles-15,urn,SUSE:SLES-BYOS:15:2019.11.15\""
  - "cd $DD_AGENT_TESTING_DIR"
  - "bash -l tasks/kitchen_setup.sh"
".kitchen_os_ubuntu":
  "before_script": &id008
  - "rsync -azr --delete ./ $SRC_PATH"
  - "export TEST_PLATFORMS=\"ubuntu-14-04,urn,Canonical:UbuntuServer:14.04.5-LTS:14.04.201905140\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|ubuntu-16-04,urn,Canonical:UbuntuServer:16.04.0-LTS:16.04.201906170\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|ubuntu-18-04,urn,Canonical:UbuntuServer:18.04-LTS:18.04.201906040\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|ubuntu-20-04,urn,Canonical:0001-com-ubuntu-server-focal:20_04-lts:20.04.202004230\""
  - "cd $DD_AGENT_TESTING_DIR"
  - "bash -l tasks/kitchen_setup.sh"
".kitchen_os_windows":
  "before_script": &id009
  - "if [ $AGENT_MAJOR_VERSION == \"7\" ]; then export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A7;\
    \ else export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A6; fi"
  - "rsync -azr --delete ./ $SRC_PATH"
  - "export TEST_PLATFORMS=\"win2008r2,id,/subscriptions/8c56d827-5f07-45ce-8f2b-6c5001db5c6f/resourceGroups/kitchen-test-images/providers/Microsoft.Compute/galleries/kitchenimages/images/Windows2008-R2-SP1/versions/1.0.0\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|win2012,urn,MicrosoftWindowsServer:WindowsServer:2012-Datacenter:3.127.20190410\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|win2012r2,urn,MicrosoftWindowsServer:WindowsServer:2012-R2-Datacenter:4.127.20190416\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|win2016,urn,MicrosoftWindowsServer:WindowsServer:2016-Datacenter-Server-Core:2016.127.20190603\""
  - "export TEST_PLATFORMS=\"$TEST_PLATFORMS|win2019,urn,MicrosoftWindowsServer:WindowsServer:2019-Datacenter-Core:2019.0.20190603\""
  - "cd $DD_AGENT_TESTING_DIR"
  - "bash -l tasks/kitchen_setup.sh"
".kitchen_scenario_centos_a6":
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a6"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
".kitchen_scenario_centos_a7":
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a7"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
".kitchen_scenario_debian_a6":
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
".kitchen_scenario_debian_a7":
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
".kitchen_scenario_suse_a6":
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a6"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
".kitchen_scenario_suse_a7":
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a7"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
".kitchen_scenario_ubuntu_a6":
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
".kitchen_scenario_ubuntu_a7":
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
".kitchen_scenario_windows_a6":
  "artifacts": *id001
  "before_script": *id009
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_windows_testing-a6"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
".kitchen_scenario_windows_a7":
  "artifacts": *id001
  "before_script": *id009
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_windows_testing-a7"
  "retry": !!int "1"
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
".kitchen_test_chef":
  "script": &id016
  - "AZURE_LOCATION='North Central US' bash -l tasks/run-test-kitchen.sh chef-test\
    \ $AGENT_MAJOR_VERSION"
".kitchen_test_install_script":
  "script": &id017
  - "AZURE_LOCATION='South Central US' bash -l tasks/run-test-kitchen.sh install-script-test\
    \ $AGENT_MAJOR_VERSION"
".kitchen_test_step_by_step":
  "script": &id018
  - "AZURE_LOCATION='Central US' bash -l tasks/run-test-kitchen.sh step-by-step-test\
    \ $AGENT_MAJOR_VERSION"
".kitchen_test_upgrade5":
  "script": &id019
  - "AZURE_LOCATION='Central US' bash -l tasks/run-test-kitchen.sh upgrade5-test $AGENT_MAJOR_VERSION"
".kitchen_test_upgrade6":
  "script": &id020
  - "AZURE_LOCATION='South Central US' bash -l tasks/run-test-kitchen.sh upgrade6-test\
    \ $AGENT_MAJOR_VERSION"
".kitchen_test_upgrade7":
  "script": &id021
  - "AZURE_LOCATION='North Central US' bash -l tasks/run-test-kitchen.sh upgrade7-test\
    \ $AGENT_MAJOR_VERSION"
".kitchen_test_windows_installer":
  "before_script": &id022
  - "if [ $AGENT_MAJOR_VERSION == \"7\" ]; then export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A7;\
    \ else export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A6; fi"
  - "rsync -azr --delete ./ $SRC_PATH"
  - "export TEST_PLATFORMS=\"win2012,urn,MicrosoftWindowsServer:WindowsServer:2012-Datacenter:3.127.20190410\""
  - "cd $DD_AGENT_TESTING_DIR"
  - "bash -l tasks/kitchen_setup.sh"
  "script": &id023
  - "AZURE_LOCATION='North Central US' bash -l tasks/run-test-kitchen.sh windows-install-test\
    \ $AGENT_MAJOR_VERSION"
".quay_variables":
  "DELEGATION_KEY_SSM_KEY": "docker_hub_signing_key"
  "DELEGATION_PASS_SSM_KEY": "docker_hub_signing_pass"
  "DOCKER_REGISTRY_LOGIN_SSM_KEY": "quay_login"
  "DOCKER_REGISTRY_PWD_SSM_KEY": "quay_pwd"
  "DOCKER_REGISTRY_URL": "quay.io"
  "SRC_AGENT": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/agent"
  "SRC_DCA": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/cluster-agent"
  "SRC_DSD": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/dogstatsd"
".run_tests_preparation":
  "before_script":
  - "source /root/.bashrc && conda activate $CONDA_ENV"
  - "pip install wheel"
  - "pip install -r requirements.txt"
  - "go get gopkg.in/yaml.v2"
  - "go get github.com/stretchr/testify"
  - "inv -e rtloader.make --install-prefix=$SRC_PATH/dev --python-runtimes \"$PYTHON_RUNTIMES\""
  - "inv -e rtloader.install"
  - "inv -e rtloader.format --raise-if-changed"
  - "inv -e rtloader.test"
  - "inv -e deps --verbose --dep-vendor-only"
  "needs": []
".system-probe_build_common":
  "before_script":
  - "mkdir -p $GOPATH/src/github.com/DataDog"
  - "[[ \"$ARCH\" == arm64 ]] && cp -R $GOPATH/src/github.com/*/*/DataDog/datadog-agent\
    \ $GOPATH/src/github.com/DataDog"
  - "cd $SRC_PATH"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  "script":
  - "inv -e system-probe.build --go-version=$SYSTEM_PROBE_GO_VERSION --no-with-bcc"
  - "inv -e system-probe.test --only-check-bpf-bytes"
  - "$S3_CP_CMD $SRC_PATH/$SYSTEM_PROBE_BINARIES_DIR/system-probe $S3_ARTIFACTS_URI/system-probe.$ARCH"
".system-probe_with-bcc_build_common":
  "before_script":
  - "mkdir -p $GOPATH/src/github.com/DataDog"
  - "[[ \"$ARCH\" == arm64 ]] && cp -R $GOPATH/src/github.com/*/*/DataDog/datadog-agent\
    \ $GOPATH/src/github.com/DataDog"
  - "cd $SRC_PATH"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  - "$S3_CP_CMD $S3_ARTIFACTS_URI/libbcc-$ARCH.tar.xz /tmp/libbcc.tar.xz"
  - "mkdir -p /opt/datadog-agent/embedded"
  - "tar -xvf /tmp/libbcc.tar.xz -C /opt/datadog-agent/embedded"
  "script":
  - "CGO_CFLAGS='-I/opt/datadog-agent/embedded/include' CGO_LDFLAGS='-Wl,-rpath,/opt/datadog-agent/embedded/lib\
    \ -L/opt/datadog-agent/embedded/lib' inv -e system-probe.build --go-version=$SYSTEM_PROBE_GO_VERSION"
  - "CGO_CFLAGS='-I/opt/datadog-agent/embedded/include' CGO_LDFLAGS='-Wl,-rpath,/opt/datadog-agent/embedded/lib\
    \ -L/opt/datadog-agent/embedded/lib' inv -e system-probe.test --only-check-bpf-bytes"
  - "$S3_CP_CMD $SRC_PATH/$SYSTEM_PROBE_BINARIES_DIR/system-probe $S3_ARTIFACTS_URI/system-probe.with-bcc.$ARCH"
".windows_main_agent_base":
  "extends": ".windows_msi_base"
  "variables":
    "OMNIBUS_TARGET": "main"
".windows_msi_base":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - ".omnibus/pkg"
  "needs": []
  "script":
  - "if (Test-Path .omnibus) { remove-item -recurse -force .omnibus }"
  - "if (Test-Path build-out) { remove-item -recurse -force build-out }"
  - "mkdir .omnibus\\pkg"
  - "docker run --rm -m 4096M -v \"$(Get-Location):c:\\mnt\" -e CI_JOB_ID=${CI_JOB_ID}\
    \ -e OMNIBUS_TARGET=${OMNIBUS_TARGET} -e WINDOWS_BUILDER=true -e RELEASE_VERSION=\"\
    $RELEASE_VERSION\" -e MAJOR_VERSION=\"$AGENT_MAJOR_VERSION\" -e PY_RUNTIMES=\"\
    $PYTHON_RUNTIMES\" -e AWS_NETWORKING=true -e SIGN_WINDOWS=true -e TARGET_ARCH=\"\
    $ARCH\" -e NEW_BUILDER=true 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/windows_1809_${ARCH}:${Env:DATADOG_AGENT_WINBUILDIMAGES}\
    \ c:\\mnt\\tasks\\winbuildscripts\\buildwin.bat"
  - "copy build-out\\${CI_JOB_ID}\\*.msi .omnibus\\pkg"
  - "if (Test-Path build-out\\${CI_JOB_ID}\\*.zip) { copy build-out\\${CI_JOB_ID}\\\
    *.zip .omnibus\\pkg }"
  - "remove-item -recurse -force build-out\\${CI_JOB_ID}"
  - "get-childitem build-out"
  - "get-childitem .omnibus\\pkg"
  "stage": "package_build"
  "tags":
  - "runner:windows-docker"
  - "windowsversion:1809"
".windows_old_main_agent_base":
  "extends": ".windows_old_msi_base"
  "variables":
    "OMNIBUS_TARGET": "main"
".windows_old_msi_base":
  "allow_failure": !!bool "true"
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - ".omnibus/pkg"
  "needs": []
  "script":
  - "if (Test-Path .omnibus) { remove-item -recurse -force .omnibus }"
  - "if (Test-Path build-out) { remove-item -recurse -force build-out }"
  - "mkdir .omnibus\\pkg"
  - "docker run --rm -m 4096M -v \"$(Get-Location):c:\\mnt\" -e CI_JOB_ID=${CI_JOB_ID}\
    \ -e OMNIBUS_TARGET=${OMNIBUS_TARGET} -e WINDOWS_BUILDER=true -e RELEASE_VERSION=\"\
    $RELEASE_VERSION\" -e MAJOR_VERSION=\"$AGENT_MAJOR_VERSION\" -e PY_RUNTIMES=\"\
    $PYTHON_RUNTIMES\" -e IS_AWS_CONTAINER=true -e SIGN_WINDOWS=true -e TARGET_ARCH=\"\
    $ARCH\" -e NEW_BUILDER=false 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/windows_1809_${ARCH}:${Env:DATADOG_AGENT_WINBUILDERS}\
    \ c:\\mnt\\tasks\\winbuildscripts\\oldbuildwin.bat"
  - "copy build-out\\${CI_JOB_ID}\\*.msi .omnibus\\pkg"
  - "if (Test-Path build-out\\${CI_JOB_ID}\\*.zip) { copy build-out\\${CI_JOB_ID}\\\
    *.zip .omnibus\\pkg }"
  - "remove-item -recurse -force build-out\\${CI_JOB_ID}"
  - "get-childitem build-out"
  - "get-childitem .omnibus\\pkg"
  "stage": "package_build"
  "tags":
  - "runner:windows-docker"
  - "windowsversion:1809"
"agent_android_apk":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR"
  "before_script":
  - "echo running android before_script"
  - "cd $SRC_PATH"
  - "pip install -U pip"
  - "pip install -r requirements.txt"
  - "inv -e deps --android --dep-vendor-only --no-checks"
  - "echo \"24333f8a63b6825ea9c5514f83c2829b004d1fee\" > \"$ANDROID_HOME/licenses/android-sdk-license\""
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/android_builder:$DATADOG_AGENT_BUILDERS"
  "script":
  - "rm -rf $OMNIBUS_PACKAGE_DIR/*"
  - "inv -e android.build --major-version 7"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR"
  - "cp ./bin/agent/ddagent-*-unsigned.apk $OMNIBUS_PACKAGE_DIR"
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
"agent_deb-arm-a6":
  "artifacts": *id010
  "before_script":
  - "source /root/.bashrc"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  - "export RELEASE_VERSION=$RELEASE_VERSION_6"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_arm64:$DATADOG_AGENT_ARMBUILDIMAGES"
  "needs":
  - "build_system-probe-arm64"
  "script": *id011
  "stage": "package_build"
  "tags":
  - "runner:docker-arm"
  - "platform:arm64"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "6"
    "DESTINATION_DBG_DEB": "datadog-agent-dbg_6_arm64.deb"
    "DESTINATION_DEB": "datadog-agent_6_arm64.deb"
    "PACKAGE_ARCH": "arm64"
    "PYTHON_RUNTIMES": "2,3"
"agent_deb-arm-a7":
  "artifacts": *id010
  "before_script":
  - "source /root/.bashrc"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  - "export RELEASE_VERSION=$RELEASE_VERSION_7"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_arm64:$DATADOG_AGENT_ARMBUILDIMAGES"
  "needs":
  - "build_system-probe-arm64"
  "script": *id011
  "stage": "package_build"
  "tags":
  - "runner:docker-arm"
  - "platform:arm64"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "DESTINATION_DBG_DEB": "datadog-agent-dbg_7_arm64.deb"
    "DESTINATION_DEB": "datadog-agent_7_arm64.deb"
    "PACKAGE_ARCH": "arm64"
    "PYTHON_RUNTIMES": "3"
"agent_deb-x64-a6":
  "artifacts": *id010
  "before_script":
  - "source /root/.bashrc && conda activate $CONDA_ENV"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  - "export RELEASE_VERSION=$RELEASE_VERSION_6"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64:$DATADOG_AGENT_BUILDIMAGES"
  "needs":
  - "build_system-probe-x64"
  "script": *id011
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:2xlarge"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "6"
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
    "CONDA_ENV": "ddpy3"
    "DESTINATION_DBG_DEB": "datadog-agent-dbg_6_amd64.deb"
    "DESTINATION_DEB": "datadog-agent_6_amd64.deb"
    "PACKAGE_ARCH": "amd64"
    "PYTHON_RUNTIMES": "2,3"
"agent_deb-x64-a7":
  "artifacts": *id010
  "before_script":
  - "source /root/.bashrc && conda activate $CONDA_ENV"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  - "export RELEASE_VERSION=$RELEASE_VERSION_7"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64:$DATADOG_AGENT_BUILDIMAGES"
  "needs":
  - "build_system-probe-x64"
  "script": *id011
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:2xlarge"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
    "CONDA_ENV": "ddpy3"
    "DESTINATION_DBG_DEB": "datadog-agent-dbg_7_amd64.deb"
    "DESTINATION_DEB": "datadog-agent_7_amd64.deb"
    "PACKAGE_ARCH": "amd64"
    "PYTHON_RUNTIMES": "3"
"agent_rpm-arm-a6":
  "artifacts": *id012
  "before_script":
  - "source /root/.bashrc"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  - "export RELEASE_VERSION=$RELEASE_VERSION_6"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/rpm_arm64:$DATADOG_AGENT_ARMBUILDIMAGES"
  "needs":
  - "build_system-probe-arm64"
  "script": *id013
  "stage": "package_build"
  "tags":
  - "runner:docker-arm"
  - "platform:arm64"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "6"
    "PACKAGE_ARCH": "arm64"
    "PYTHON_RUNTIMES": "2,3"
"agent_rpm-arm-a7":
  "artifacts": *id012
  "before_script":
  - "source /root/.bashrc"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  - "export RELEASE_VERSION=$RELEASE_VERSION_7"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/rpm_arm64:$DATADOG_AGENT_ARMBUILDIMAGES"
  "needs":
  - "build_system-probe-arm64"
  "script": *id013
  "stage": "package_build"
  "tags":
  - "runner:docker-arm"
  - "platform:arm64"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "PACKAGE_ARCH": "arm64"
    "PYTHON_RUNTIMES": "3"
"agent_rpm-x64-a6":
  "artifacts": *id012
  "before_script":
  - "source /root/.bashrc && conda activate $CONDA_ENV"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  - "export RELEASE_VERSION=$RELEASE_VERSION_6"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/rpm_x64:$DATADOG_AGENT_BUILDIMAGES"
  "needs":
  - "build_system-probe-x64"
  "script": *id013
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:2xlarge"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "6"
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
    "CONDA_ENV": "ddpy3"
    "PACKAGE_ARCH": "amd64"
    "PYTHON_RUNTIMES": "2,3"
"agent_rpm-x64-a7":
  "artifacts": *id012
  "before_script":
  - "source /root/.bashrc && conda activate $CONDA_ENV"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  - "export RELEASE_VERSION=$RELEASE_VERSION_7"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/rpm_x64:$DATADOG_AGENT_BUILDIMAGES"
  "needs":
  - "build_system-probe-x64"
  "script": *id013
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:2xlarge"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
    "CONDA_ENV": "ddpy3"
    "PACKAGE_ARCH": "amd64"
    "PYTHON_RUNTIMES": "3"
"agent_suse-x64-a6":
  "artifacts": *id014
  "before_script":
  - "export RELEASE_VERSION=$RELEASE_VERSION_6"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/suse_x64:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "build_system-probe-x64"
  "script": *id015
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:2xlarge"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "6"
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
    "PACKAGE_ARCH": "amd64"
    "PYTHON_RUNTIMES": "2,3"
"agent_suse-x64-a7":
  "artifacts": *id014
  "before_script":
  - "export RELEASE_VERSION=$RELEASE_VERSION_7"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/suse_x64:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "build_system-probe-x64"
  "script": *id015
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:2xlarge"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
    "PACKAGE_ARCH": "amd64"
    "PYTHON_RUNTIMES": "3"
"agent_with-bcc_deb-x64-a7":
  "artifacts": *id010
  "before_script":
  - "source /root/.bashrc && conda activate $CONDA_ENV"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  - "export RELEASE_VERSION=$RELEASE_VERSION_7"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64:$DATADOG_AGENT_BUILDIMAGES"
  "needs":
  - "build_system-probe_with-bcc-x64"
  "script": *id011
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:2xlarge"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
    "CONDA_ENV": "ddpy3"
    "DESTINATION_DBG_DEB": "datadog-agent-with-bcc-dbg_7_amd64.deb"
    "DESTINATION_DEB": "datadog-agent-with-bcc_7_amd64.deb"
    "PACKAGE_ARCH": "amd64"
    "PYTHON_RUNTIMES": "3"
"build_libbcc_arm64":
  "extends": ".build_libbcc_common"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/system-probe_arm64:$DATADOG_AGENT_ARMBUILDIMAGES"
  "tags":
  - "runner:docker-arm"
  - "platform:arm64"
  "variables":
    "ARCH": "arm64"
"build_libbcc_x64":
  "extends": ".build_libbcc_common"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/system-probe_x64:$DATADOG_AGENT_BUILDIMAGES"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "ARCH": "amd64"
"build_system-probe-arm64":
  "extends": ".system-probe_build_common"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/system-probe_arm64:$DATADOG_AGENT_SYSPROBE_BUILDIMAGES"
  "needs": []
  "stage": "binary_build"
  "tags":
  - "runner:docker-arm"
  - "platform:arm64"
  "variables":
    "ARCH": "arm64"
"build_system-probe-x64":
  "extends": ".system-probe_build_common"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/system-probe_x64:$DATADOG_AGENT_SYSPROBE_BUILDIMAGES"
  "needs": []
  "stage": "binary_build"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "ARCH": "amd64"
"build_system-probe_with-bcc-arm64":
  "extends": ".system-probe_with-bcc_build_common"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/system-probe_arm64:$DATADOG_AGENT_SYSPROBE_BUILDIMAGES"
  "needs":
  - "build_libbcc_arm64"
  "stage": "binary_build"
  "tags":
  - "runner:docker-arm"
  - "platform:arm64"
  "variables":
    "ARCH": "arm64"
"build_system-probe_with-bcc-x64":
  "extends": ".system-probe_with-bcc_build_common"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/system-probe_x64:$DATADOG_AGENT_SYSPROBE_BUILDIMAGES"
  "needs":
  - "build_libbcc_x64"
  "stage": "binary_build"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "ARCH": "amd64"
"default":
  "retry":
    "max": !!int "2"
    "when":
    - "runner_system_failure"
    - "stuck_or_timeout_failure"
    - "unknown_failure"
    - "api_failure"
"deploy_deb_testing-a6":
  "before_script":
  - "ls $OMNIBUS_PACKAGE_DIR"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "agent_deb-x64-a6"
  "script":
  - "source /usr/local/rvm/scripts/rvm"
  - "rvm use 2.4"
  - "set +x"
  - "APT_SIGNING_KEY_ID=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.apt_signing_key_id\
    \ --with-decryption --query \"Parameter.Value\" --out text)"
  - "APT_SIGNING_PRIVATE_KEY_PART1=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.apt_signing_private_key_part1 --with-decryption --query \"\
    Parameter.Value\" --out text)"
  - "APT_SIGNING_PRIVATE_KEY_PART2=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.apt_signing_private_key_part2 --with-decryption --query \"\
    Parameter.Value\" --out text)"
  - "APT_SIGNING_KEY_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.apt_signing_key_passphrase --with-decryption --query \"Parameter.Value\"\
    \ --out text)"
  - "echo \"$APT_SIGNING_KEY_ID\""
  - "printf -- \"$APT_SIGNING_PRIVATE_KEY_PART1\\n$APT_SIGNING_PRIVATE_KEY_PART2\\\
    n\" | gpg --import --batch"
  - "echo \"$APT_SIGNING_KEY_PASSPHRASE\" | deb-s3 upload -c \"pipeline-$DD_PIPELINE_ID\"\
    \ -m 6 -b $DEB_TESTING_S3_BUCKET -a amd64 --sign=$APT_SIGNING_KEY_ID --gpg_options=\"\
    --passphrase-fd 0 --pinentry-mode loopback --batch --digest-algo SHA512\" --preserve_versions\
    \ --visibility public $OMNIBUS_PACKAGE_DIR/datadog-*_6*amd64.deb"
  - "echo \"$APT_SIGNING_KEY_PASSPHRASE\" | deb-s3 upload -c \"pipeline-$DD_PIPELINE_ID\"\
    \ -m 6 -b $DEB_TESTING_S3_BUCKET -a x86_64 --sign=$APT_SIGNING_KEY_ID --gpg_options=\"\
    --passphrase-fd 0 --pinentry-mode loopback --batch --digest-algo SHA512\" --preserve_versions\
    \ --visibility public $OMNIBUS_PACKAGE_DIR/datadog-*_6*amd64.deb"
  "stage": "testkitchen_deploy"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a6"
"deploy_deb_testing-a7":
  "before_script":
  - "ls $OMNIBUS_PACKAGE_DIR"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "agent_deb-x64-a7"
  "script":
  - "source /usr/local/rvm/scripts/rvm"
  - "rvm use 2.4"
  - "set +x"
  - "APT_SIGNING_KEY_ID=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.apt_signing_key_id\
    \ --with-decryption --query \"Parameter.Value\" --out text)"
  - "APT_SIGNING_PRIVATE_KEY_PART1=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.apt_signing_private_key_part1 --with-decryption --query \"\
    Parameter.Value\" --out text)"
  - "APT_SIGNING_PRIVATE_KEY_PART2=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.apt_signing_private_key_part2 --with-decryption --query \"\
    Parameter.Value\" --out text)"
  - "APT_SIGNING_KEY_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.apt_signing_key_passphrase --with-decryption --query \"Parameter.Value\"\
    \ --out text)"
  - "echo \"$APT_SIGNING_KEY_ID\""
  - "printf -- \"$APT_SIGNING_PRIVATE_KEY_PART1\\n$APT_SIGNING_PRIVATE_KEY_PART2\\\
    n\" | gpg --import --batch"
  - "echo \"$APT_SIGNING_KEY_PASSPHRASE\" | deb-s3 upload -c \"pipeline-$DD_PIPELINE_ID\"\
    \ -m 7 -b $DEB_TESTING_S3_BUCKET -a amd64 --sign=$APT_SIGNING_KEY_ID --gpg_options=\"\
    --passphrase-fd 0 --pinentry-mode loopback --batch --digest-algo SHA512\" --preserve_versions\
    \ --visibility public $OMNIBUS_PACKAGE_DIR/datadog-*_7*amd64.deb"
  - "echo \"$APT_SIGNING_KEY_PASSPHRASE\" | deb-s3 upload -c \"pipeline-$DD_PIPELINE_ID\"\
    \ -m 7 -b $DEB_TESTING_S3_BUCKET -a x86_64 --sign=$APT_SIGNING_KEY_ID --gpg_options=\"\
    --passphrase-fd 0 --pinentry-mode loopback --batch --digest-algo SHA512\" --preserve_versions\
    \ --visibility public $OMNIBUS_PACKAGE_DIR/datadog-*_7*amd64.deb"
  "stage": "testkitchen_deploy"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a7"
"deploy_rpm_testing-a6":
  "before_script":
  - "ls $OMNIBUS_PACKAGE_DIR"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "agent_rpm-x64-a6"
  "script":
  - "source /usr/local/rvm/scripts/rvm"
  - "rvm use 2.4"
  - "mkdir -p ./rpmrepo/x86_64/"
  - "aws s3 sync s3://$RPM_TESTING_S3_BUCKET/pipeline-$DD_PIPELINE_ID/6 ./rpmrepo/"
  - "cp $OMNIBUS_PACKAGE_DIR/datadog-*-6.*x86_64.rpm ./rpmrepo/x86_64/"
  - "createrepo --update -v --checksum sha ./rpmrepo/x86_64"
  - "aws s3 sync ./rpmrepo/ s3://$RPM_TESTING_S3_BUCKET/pipeline-$DD_PIPELINE_ID/6\
    \ --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers full=id=3a6e02b08553fd157ae3fb918945dd1eaae5a1aa818940381ef07a430cf25732"
  "stage": "testkitchen_deploy"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a6"
"deploy_rpm_testing-a7":
  "before_script":
  - "ls $OMNIBUS_PACKAGE_DIR"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "agent_rpm-x64-a7"
  "script":
  - "source /usr/local/rvm/scripts/rvm"
  - "rvm use 2.4"
  - "mkdir -p ./rpmrepo/x86_64/"
  - "aws s3 sync s3://$RPM_TESTING_S3_BUCKET/pipeline-$DD_PIPELINE_ID/7 ./rpmrepo/"
  - "cp $OMNIBUS_PACKAGE_DIR/datadog-*-7.*x86_64.rpm ./rpmrepo/x86_64/"
  - "createrepo --update -v --checksum sha ./rpmrepo/x86_64"
  - "aws s3 sync ./rpmrepo/ s3://$RPM_TESTING_S3_BUCKET/pipeline-$DD_PIPELINE_ID/7\
    \ --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers full=id=3a6e02b08553fd157ae3fb918945dd1eaae5a1aa818940381ef07a430cf25732"
  "stage": "testkitchen_deploy"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a7"
"deploy_suse_rpm_testing-a6":
  "before_script":
  - "ls $OMNIBUS_PACKAGE_DIR_SUSE"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "agent_suse-x64-a6"
  "script":
  - "source /usr/local/rvm/scripts/rvm"
  - "rvm use 2.4"
  - "mkdir -p ./rpmrepo/suse/x86_64/"
  - "aws s3 sync s3://$RPM_TESTING_S3_BUCKET/suse/pipeline-$DD_PIPELINE_ID/6 ./rpmrepo/suse"
  - "cp $OMNIBUS_PACKAGE_DIR_SUSE/datadog-*-6.*x86_64.rpm ./rpmrepo/suse/x86_64/"
  - "createrepo --update -v --checksum sha ./rpmrepo/suse/x86_64"
  - "aws s3 sync ./rpmrepo/suse/ s3://$RPM_TESTING_S3_BUCKET/suse/pipeline-$DD_PIPELINE_ID/6\
    \ --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers full=id=3a6e02b08553fd157ae3fb918945dd1eaae5a1aa818940381ef07a430cf25732"
  "stage": "testkitchen_deploy"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a6"
"deploy_suse_rpm_testing-a7":
  "before_script":
  - "ls $OMNIBUS_PACKAGE_DIR_SUSE"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "agent_suse-x64-a7"
  "script":
  - "source /usr/local/rvm/scripts/rvm"
  - "rvm use 2.4"
  - "mkdir -p ./rpmrepo/suse/x86_64/"
  - "aws s3 sync s3://$RPM_TESTING_S3_BUCKET/suse/pipeline-$DD_PIPELINE_ID/7 ./rpmrepo/suse"
  - "cp $OMNIBUS_PACKAGE_DIR_SUSE/datadog-*-7.*x86_64.rpm ./rpmrepo/suse/x86_64/"
  - "createrepo --update -v --checksum sha ./rpmrepo/suse/x86_64"
  - "aws s3 sync ./rpmrepo/suse/ s3://$RPM_TESTING_S3_BUCKET/suse/pipeline-$DD_PIPELINE_ID/7\
    \ --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers full=id=3a6e02b08553fd157ae3fb918945dd1eaae5a1aa818940381ef07a430cf25732"
  "stage": "testkitchen_deploy"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a7"
"deploy_windows_testing-a6":
  "before_script":
  - "ls $OMNIBUS_PACKAGE_DIR"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "windows_msi_x64-a6"
  "script":
  - "$S3_CP_CMD --recursive --exclude \"*\" --include \"datadog-agent-6.*.msi\" $OMNIBUS_PACKAGE_DIR\
    \ s3://$WIN_S3_BUCKET/$WINDOWS_TESTING_S3_BUCKET_A6 --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers\
    \ full=id=3a6e02b08553fd157ae3fb918945dd1eaae5a1aa818940381ef07a430cf25732"
  "stage": "testkitchen_deploy"
  "tags":
  - "runner:main"
  - "size:large"
"deploy_windows_testing-a7":
  "before_script":
  - "ls $OMNIBUS_PACKAGE_DIR"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "windows_msi_x64-a7"
  "script":
  - "$S3_CP_CMD --recursive --exclude \"*\" --include \"datadog-agent-7.*.msi\" $OMNIBUS_PACKAGE_DIR\
    \ s3://$WIN_S3_BUCKET/$WINDOWS_TESTING_S3_BUCKET_A7 --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers\
    \ full=id=3a6e02b08553fd157ae3fb918945dd1eaae5a1aa818940381ef07a430cf25732"
  "stage": "testkitchen_deploy"
  "tags":
  - "runner:main"
  - "size:large"
"dogstatsd_deb-x64":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR"
  "before_script":
  - "source /root/.bashrc && conda activate ddpy3"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64:$DATADOG_AGENT_BUILDIMAGES"
  "needs": []
  "script":
  - "rm -rf $OMNIBUS_PACKAGE_DIR/*"
  - "inv -e dogstatsd.omnibus-build --release-version \"$RELEASE_VERSION_7\" --major-version\
    \ 7 --base-dir $OMNIBUS_BASE_DIR ${USE_S3_CACHING} --skip-deps"
  - "find $OMNIBUS_BASE_DIR/pkg -name \"datadog-dogstatsd*_amd64.deb\" -exec dpkg\
    \ -c {} \\;"
  - "$S3_CP_CMD $OMNIBUS_BASE_DIR/pkg/datadog-dogstatsd*_amd64.deb $S3_ARTIFACTS_URI/datadog-dogstatsd_amd64.deb"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/datadog-dogstatsd*_amd64.deb{,.metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR"
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
"dogstatsd_rpm-x64":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR"
  "before_script":
  - "source /root/.bashrc && conda activate ddpy3"
  - "inv -e deps --no-checks --verbose --dep-vendor-only"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/rpm_x64:$DATADOG_AGENT_BUILDIMAGES"
  "needs": []
  "script":
  - "rm -rf $OMNIBUS_PACKAGE_DIR/*"
  - "set +x"
  - "RPM_GPG_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.rpm_signing_private_key\
    \ --with-decryption --query \"Parameter.Value\" --out text)"
  - "printf -- \"$RPM_GPG_KEY\" | gpg --import --batch"
  - "export RPM_SIGNING_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.rpm_signing_key_passphrase --with-decryption --query \"Parameter.Value\"\
    \ --out text)"
  - "set -x"
  - "inv -e dogstatsd.omnibus-build --release-version \"$RELEASE_VERSION_7\" --major-version\
    \ 7 --base-dir $OMNIBUS_BASE_DIR ${USE_S3_CACHING} --skip-deps"
  - "find $OMNIBUS_BASE_DIR/pkg -type f -name '*.rpm' -print0 | sort -z | xargs -0\
    \ -I '{}' rpm -i '{}'"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/*.{rpm,metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR"
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
"dogstatsd_suse-x64":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR_SUSE"
  "before_script":
  - "inv -e deps --no-checks --dep-vendor-only"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/suse_x64:$DATADOG_AGENT_BUILDERS"
  "needs": []
  "script":
  - "rm -rf $OMNIBUS_PACKAGE_DIR_SUSE/*"
  - "set +x"
  - "RPM_GPG_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.rpm_signing_private_key\
    \ --with-decryption --query \"Parameter.Value\" --out text)"
  - "printf -- \"$RPM_GPG_KEY\" | gpg --import --batch"
  - "export RPM_SIGNING_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.rpm_signing_key_passphrase --with-decryption --query \"Parameter.Value\"\
    \ --out text)"
  - "set -x"
  - "inv -e dogstatsd.omnibus-build --release-version \"$RELEASE_VERSION_7\" --major-version\
    \ 7 --base-dir $OMNIBUS_BASE_DIR_SUSE ${USE_S3_CACHING} --skip-deps"
  - "find $OMNIBUS_BASE_DIR_SUSE/pkg -type f -name '*.rpm' -print0 | sort -z | xargs\
    \ -0 -I '{}' rpm -i '{}'"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR_SUSE && cp $OMNIBUS_BASE_DIR_SUSE/pkg/*.{rpm,metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR_SUSE"
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:large"
  "variables":
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
"include": "https://gitlab-templates.ddbuild.io/slack-notifier/v1/template.yml"
"iot_agent_deb-arm64":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR"
  "before_script":
  - "source /root/.bashrc"
  - "inv -e deps --verbose --dep-vendor-only"
  - "export RELEASE_VERSION=$RELEASE_VERSION_7"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_arm64:$DATADOG_AGENT_ARMBUILDIMAGES"
  "needs": []
  "script":
  - "rm -rf $OMNIBUS_PACKAGE_DIR/*"
  - "inv -e agent.omnibus-build --iot --log-level debug --release-version \"$RELEASE_VERSION_7\"\
    \ --major-version 7 --base-dir $OMNIBUS_BASE_DIR --skip-deps"
  - "find $OMNIBUS_BASE_DIR/pkg"
  - "find $OMNIBUS_BASE_DIR/pkg -name \"datadog-iot-agent*_arm64.deb\" -exec dpkg\
    \ -c {} \\;"
  - "$S3_CP_CMD $OMNIBUS_BASE_DIR/pkg/datadog-iot-agent*_arm64.deb $S3_ARTIFACTS_URI/datadog-iot-agent_arm64.deb"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/datadog-iot-agent*_arm64.deb{,.metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR"
  "stage": "package_build"
  "tags":
  - "runner:docker-arm"
  - "platform:arm64"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "PYTHON_RUNTIMES": "3"
"iot_agent_deb-x64":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR"
  "before_script":
  - "source /root/.bashrc && conda activate ddpy3"
  - "inv -e deps --verbose --dep-vendor-only --no-checks"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64:$DATADOG_AGENT_BUILDIMAGES"
  "needs": []
  "script":
  - "rm -rf $OMNIBUS_PACKAGE_DIR/*"
  - "inv -e agent.omnibus-build --iot --log-level debug --release-version \"$RELEASE_VERSION_7\"\
    \ --major-version 7 --base-dir $OMNIBUS_BASE_DIR --skip-deps"
  - "find $OMNIBUS_BASE_DIR/pkg -name \"datadog-iot-agent*_amd64.deb\" -exec dpkg\
    \ -c {} \\;"
  - "$S3_CP_CMD $OMNIBUS_BASE_DIR/pkg/datadog-iot-agent*_amd64.deb $S3_ARTIFACTS_URI/datadog-iot-agent_amd64.deb"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/datadog-iot-agent*_amd64.deb{,.metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR"
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:2xlarge"
  "variables":
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
    "PACKAGE_ARCH": "amd64"
"iot_agent_rpm-arm64":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR"
  "before_script":
  - "source /root/.bashrc"
  - "inv -e deps --verbose --dep-vendor-only"
  - "export RELEASE_VERSION=$RELEASE_VERSION_7"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/rpm_arm64:$DATADOG_AGENT_ARMBUILDIMAGES"
  "needs": []
  "script":
  - "echo \"About to build iot agent for $RELEASE_VERSION\""
  - "rm -rf $OMNIBUS_PACKAGE_DIR/*"
  - "set +x"
  - "RPM_GPG_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.rpm_signing_private_key_e09422b3\
    \ --with-decryption --query \"Parameter.Value\" --out text)"
  - "printf -- \"$RPM_GPG_KEY\" | gpg --import --batch"
  - "export RPM_SIGNING_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.rpm_signing_key_passphrase_e09422b3 --with-decryption --query\
    \ \"Parameter.Value\" --out text)"
  - "set -x"
  - "inv -e agent.omnibus-build --iot --log-level debug --release-version \"$RELEASE_VERSION_7\"\
    \ --major-version 7 --base-dir $OMNIBUS_BASE_DIR --skip-deps"
  - "ls $OMNIBUS_BASE_DIR/pkg/"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/*.{rpm,metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR"
  "stage": "package_build"
  "tags":
  - "runner:docker-arm"
  - "platform:arm64"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "PYTHON_RUNTIMES": "3"
"iot_agent_rpm-x64":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR"
  "before_script":
  - "source /root/.bashrc && conda activate ddpy3"
  - "inv -e deps --verbose --dep-vendor-only --no-checks"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/rpm_x64:$DATADOG_AGENT_BUILDIMAGES"
  "needs": []
  "script":
  - "rm -rf $OMNIBUS_PACKAGE_DIR/*"
  - "set +x"
  - "RPM_GPG_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.rpm_signing_private_key_e09422b3\
    \ --with-decryption --query \"Parameter.Value\" --out text)"
  - "printf -- \"$RPM_GPG_KEY\" | gpg --import --batch"
  - "export RPM_SIGNING_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.rpm_signing_key_passphrase_e09422b3 --with-decryption --query\
    \ \"Parameter.Value\" --out text)"
  - "set -x"
  - "inv -e agent.omnibus-build --iot --log-level debug --release-version \"$RELEASE_VERSION_7\"\
    \ --major-version 7 --base-dir $OMNIBUS_BASE_DIR --skip-deps"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/*.{rpm,metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR"
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:2xlarge"
  "variables":
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
"iot_agent_suse-x64":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - "$OMNIBUS_PACKAGE_DIR_SUSE"
  "before_script":
  - "source /root/.bashrc && conda activate ddpy3"
  - "inv -e deps --verbose --dep-vendor-only --no-checks"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/suse_x64:$DATADOG_AGENT_BUILDERS"
  "needs": []
  "script":
  - "rm -rf $OMNIBUS_PACKAGE_DIR_SUSE/*"
  - "set +x"
  - "RPM_GPG_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.rpm_signing_private_key_e09422b3\
    \ --with-decryption --query \"Parameter.Value\" --out text)"
  - "printf -- \"$RPM_GPG_KEY\" | gpg --import --batch"
  - "export RPM_SIGNING_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name\
    \ ci.datadog-agent.rpm_signing_key_passphrase_e09422b3 --with-decryption --query\
    \ \"Parameter.Value\" --out text)"
  - "set -x"
  - "inv -e agent.omnibus-build --iot --log-level debug --release-version \"$RELEASE_VERSION_7\"\
    \ --major-version 7 --base-dir $OMNIBUS_BASE_DIR --skip-deps"
  - "mkdir -p $OMNIBUS_PACKAGE_DIR_SUSE && cp $OMNIBUS_BASE_DIR/pkg/*.{rpm,metadata.json}\
    \ $OMNIBUS_PACKAGE_DIR_SUSE"
  "stage": "package_build"
  "tags":
  - "runner:main"
  - "size:2xlarge"
  "variables":
    "AWS_CONTAINER_CREDENTIALS_RELATIVE_URI": "/credentials"
"kitchen_centos_chef-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a6"
  "retry": !!int "1"
  "script": *id016
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_centos_chef-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id016
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_centos_install_script-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a6"
  "retry": !!int "1"
  "script": *id017
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_centos_install_script-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id017
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_centos_step_by_step-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a6"
  "retry": !!int "1"
  "script": *id018
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_centos_step_by_step-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id018
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_centos_upgrade5-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a6"
  "retry": !!int "1"
  "script": *id019
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_centos_upgrade5-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id019
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_centos_upgrade6-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a6"
  "retry": !!int "1"
  "script": *id020
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_centos_upgrade6-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id020
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_centos_upgrade7-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id003
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id021
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_debian_chef-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "script": *id016
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_debian_chef-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id016
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_debian_install_script-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "script": *id017
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_debian_install_script-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id017
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_debian_step_by_step-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "script": *id018
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_debian_step_by_step-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id018
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_debian_upgrade5-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "script": *id019
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_debian_upgrade5-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id019
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_debian_upgrade6-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "script": *id020
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_debian_upgrade6-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id020
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_debian_upgrade7-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id006
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id021
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_suse_chef-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a6"
  "retry": !!int "1"
  "script": *id016
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_suse_chef-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id016
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_suse_install_script-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a6"
  "retry": !!int "1"
  "script": *id017
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_suse_install_script-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id017
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_suse_step_by_step-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a6"
  "retry": !!int "1"
  "script": *id018
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_suse_step_by_step-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id018
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_suse_upgrade5-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a6"
  "retry": !!int "1"
  "script": *id019
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_suse_upgrade5-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id019
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_suse_upgrade6-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a6"
  "retry": !!int "1"
  "script": *id020
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_suse_upgrade6-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id020
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_suse_upgrade7-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id007
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_suse_rpm_testing-a7"
  "retry": !!int "1"
  "script": *id021
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_ubuntu_chef-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "script": *id016
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_ubuntu_chef-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id016
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_ubuntu_install_script-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "script": *id017
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_ubuntu_install_script-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id017
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_ubuntu_step_by_step-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "script": *id018
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_ubuntu_step_by_step-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id018
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_ubuntu_upgrade5-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "script": *id019
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_ubuntu_upgrade5-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id019
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_ubuntu_upgrade6-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a6"
  "retry": !!int "1"
  "script": *id020
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_ubuntu_upgrade6-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id020
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_ubuntu_upgrade7-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id008
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_deb_testing-a7"
  "retry": !!int "1"
  "script": *id021
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_windows_chef-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id009
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_windows_testing-a6"
  "retry": !!int "1"
  "script": *id016
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_windows_chef-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id009
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_windows_testing-a7"
  "retry": !!int "1"
  "script": *id016
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_windows_installer-a6":
  "allow_failure": !!bool "true"
  "artifacts": *id001
  "before_script": *id022
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_windows_testing-a6"
  "retry": !!int "0"
  "script": *id023
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_windows_installer-a7":
  "allow_failure": !!bool "true"
  "artifacts": *id001
  "before_script": *id022
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_windows_testing-a7"
  "retry": !!int "0"
  "script": *id023
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_windows_upgrade5-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id009
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_windows_testing-a6"
  "retry": !!int "1"
  "script": *id019
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_windows_upgrade5-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id009
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_windows_testing-a7"
  "retry": !!int "1"
  "script": *id019
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_windows_upgrade6-a6":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id009
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_windows_testing-a6"
  "retry": !!int "1"
  "script": *id020
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id004
"kitchen_windows_upgrade6-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id009
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_windows_testing-a7"
  "retry": !!int "1"
  "script": *id020
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"kitchen_windows_upgrade7-a7":
  "allow_failure": !!bool "false"
  "artifacts": *id001
  "before_script": *id009
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "needs":
  - "deploy_windows_testing-a7"
  "retry": !!int "1"
  "script": *id021
  "stage": "testkitchen_testing"
  "tags": *id002
  "variables": *id005
"stages":
- "deps_build"
- "binary_build"
- "package_build"
- "testkitchen_deploy"
- "testkitchen_testing"
- "testkitchen_cleanup"
"testkitchen_cleanup_azure-a6":
  "allow_failure": !!bool "true"
  "before_script": *id024
  "dependencies": *id025
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "script": *id026
  "stage": "testkitchen_cleanup"
  "tags": *id027
  "variables":
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a6"
  "when": "always"
"testkitchen_cleanup_azure-a7":
  "allow_failure": !!bool "true"
  "before_script": *id024
  "dependencies": *id025
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS"
  "script": *id026
  "stage": "testkitchen_cleanup"
  "tags": *id027
  "variables":
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a7"
  "when": "always"
"testkitchen_cleanup_s3-a6":
  "allow_failure": !!bool "true"
  "dependencies":
  - "agent_deb-x64-a6"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS"
  "script": *id028
  "stage": "testkitchen_cleanup"
  "tags": *id029
  "variables":
    "AGENT_MAJOR_VERSION": !!int "6"
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a6"
  "when": "always"
"testkitchen_cleanup_s3-a7":
  "allow_failure": !!bool "true"
  "dependencies":
  - "agent_deb-x64-a7"
  "image": "486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS"
  "script": *id028
  "stage": "testkitchen_cleanup"
  "tags": *id029
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "DD_PIPELINE_ID": "$CI_PIPELINE_ID-a7"
  "when": "always"
"variables":
  "AGENT_BINARIES_DIR": "bin/agent"
  "ANDROID_BUILDS_S3_BUCKET": "$ANDROID_S3_BUCKET/builds"
  "ANDROID_S3_BUCKET": "dd-agent-androidtesting"
  "BCC_VERSION": "v0.12.0"
  "CLUSTER_AGENT_BINARIES_DIR": "bin/datadog-cluster-agent"
  "CLUSTER_AGENT_CLOUDFOUNDRY_BINARIES_DIR": "bin/datadog-cluster-agent-cloudfoundry"
  "DATADOG_AGENT_ARMBUILDIMAGES": "v2424505-0439a40"
  "DATADOG_AGENT_BUILDERS": "v2448672-5304c3c"
  "DATADOG_AGENT_BUILDIMAGES": "v2424505-0439a40"
  "DATADOG_AGENT_SYSPROBE_BUILDIMAGES": "v2424505-0439a40"
  "DATADOG_AGENT_WINBUILDERS": "v2348149-ba6640d"
  "DATADOG_AGENT_WINBUILDIMAGES": "v2468030-cbaf3fe"
  "DD_AGENT_TESTING_DIR": "$CI_PROJECT_DIR/test/kitchen"
  "DD_REPO_BRANCH_NAME": "$CI_COMMIT_REF_NAME"
  "DEB_RPM_BUCKET_BRANCH": "nightly"
  "DEB_RPM_TESTING_BUCKET_BRANCH": "testing"
  "DEB_S3_BUCKET": "apt.datad0g.com"
  "DEB_TESTING_S3_BUCKET": "apttesting.datad0g.com"
  "DOGSTATSD_BINARIES_DIR": "bin/dogstatsd"
  "OMNIBUS_BASE_DIR": "/.omnibus"
  "OMNIBUS_BASE_DIR_SUSE": "/.omnibus/suse"
  "OMNIBUS_BASE_DIR_WIN": "c:\\omni-base\\$CI_RUNNER_ID"
  "OMNIBUS_BASE_DIR_WIN_OMNIBUS": "c:/omni-base/$CI_RUNNER_ID"
  "OMNIBUS_PACKAGE_DIR": "$CI_PROJECT_DIR/.omnibus/pkg/"
  "OMNIBUS_PACKAGE_DIR_SUSE": "$CI_PROJECT_DIR/.omnibus/suse/pkg"
  "PROCESS_S3_BUCKET": "datad0g-process-agent"
  "RELEASE_VERSION_6": "nightly"
  "RELEASE_VERSION_7": "nightly-a7"
  "RPM_S3_BUCKET": "yum.datad0g.com"
  "RPM_TESTING_S3_BUCKET": "yumtesting.datad0g.com"
  "S3_ARTIFACTS_URI": "s3://dd-ci-artefacts-build-stable/$CI_PROJECT_NAME/$CI_PIPELINE_ID"
  "S3_CP_CMD": "aws s3 cp $S3_CP_OPTIONS"
  "S3_CP_OPTIONS": "--only-show-errors --region us-east-1 --sse AES256"
  "S3_DSD6_URI": "s3://dsd6-staging"
  "S3_OMNIBUS_CACHE_BUCKET": "dd-ci-datadog-agent-omnibus-cache-build-stable"
  "SRC_PATH": "/go/src/github.com/DataDog/datadog-agent"
  "STATIC_BINARIES_DIR": "bin/static"
  "SYSTEM_PROBE_BINARIES_DIR": "bin/system-probe"
  "SYSTEM_PROBE_GO_VERSION": "1.13.8"
  "USE_S3_CACHING": "--omnibus-s3-cache"
  "WINDOWS_BUILDS_S3_BUCKET": "$WIN_S3_BUCKET/builds"
  "WINDOWS_TESTING_S3_BUCKET_A6": "pipelines/A6/$CI_PIPELINE_ID"
  "WINDOWS_TESTING_S3_BUCKET_A7": "pipelines/A7/$CI_PIPELINE_ID"
  "WIN_S3_BUCKET": "dd-agent-mstesting"
"windows_dsd_msi_x64-a7":
  "before_script":
  - "set RELEASE_VERSION $RELEASE_VERSION_7"
  "extends": ".windows_msi_base"
  "variables":
    "AGENT_MAJOR_VERSION": "7"
    "ARCH": "x64"
    "OMNIBUS_TARGET": "dogstatsd"
    "PYTHON_RUNTIMES": ""
"windows_msi_x64-a6":
  "before_script":
  - "set RELEASE_VERSION $RELEASE_VERSION_6"
  "extends": ".windows_main_agent_base"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "6"
    "ARCH": "x64"
    "PYTHON_RUNTIMES": "2,3"
"windows_msi_x64-a7":
  "before_script":
  - "set RELEASE_VERSION $RELEASE_VERSION_7"
  "extends": ".windows_main_agent_base"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "ARCH": "x64"
    "PYTHON_RUNTIMES": "3"
"windows_msi_x86-a6":
  "allow_failure": !!bool "true"
  "before_script":
  - "set RELEASE_VERSION $RELEASE_VERSION_6"
  "extends": ".windows_main_agent_base"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "6"
    "ARCH": "x86"
    "PYTHON_RUNTIMES": "2,3"
"windows_msi_x86-a7":
  "allow_failure": !!bool "true"
  "before_script":
  - "set RELEASE_VERSION $RELEASE_VERSION_7"
  "extends": ".windows_main_agent_base"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "ARCH": "x86"
    "PYTHON_RUNTIMES": "3"
"windows_old_msi_x64-a6":
  "before_script":
  - "set RELEASE_VERSION $RELEASE_VERSION_6"
  "extends": ".windows_old_main_agent_base"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "6"
    "ARCH": "x64"
    "PYTHON_RUNTIMES": "2,3"
"windows_old_msi_x64-a7":
  "before_script":
  - "set RELEASE_VERSION $RELEASE_VERSION_7"
  "extends": ".windows_old_main_agent_base"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "ARCH": "x64"
    "PYTHON_RUNTIMES": "3"
"windows_zip_agent_binaries_x64-a7":
  "artifacts":
    "expire_in": "2 weeks"
    "paths":
    - ".omnibus/pkg"
  "before_script":
  - "set RELEASE_VERSION $RELEASE_VERSION_7"
  "needs": []
  "script":
  - "if (Test-Path .omnibus) { remove-item -recurse -force .omnibus }"
  - "if (Test-Path build-out) { remove-item -recurse -force build-out }"
  - "mkdir .omnibus\\pkg"
  - "docker run --rm -m 4096M -v \"$(Get-Location):c:\\mnt\" -e OMNIBUS_TARGET=${OMNIBUS_TARGET}\
    \ -e WINDOWS_BUILDER=true -e RELEASE_VERSION=\"$RELEASE_VERSION\" -e MAJOR_VERSION=\"\
    $AGENT_MAJOR_VERSION\" -e PY_RUNTIMES=\"$PYTHON_RUNTIMES\" -e AWS_NETWORKING=true\
    \ -e SIGN_WINDOWS=true 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/windows_1809_${ARCH}:${Env:DATADOG_AGENT_WINBUILDIMAGES}\
    \ c:\\mnt\\tasks\\winbuildscripts\\buildwin.bat"
  - "copy build-out\\*.zip .omnibus\\pkg"
  "stage": "package_build"
  "tags":
  - "runner:windows-docker"
  - "windowsversion:1809"
  "variables":
    "AGENT_MAJOR_VERSION": !!int "7"
    "ARCH": "x64"
    "OMNIBUS_TARGET": "agent_binaries"

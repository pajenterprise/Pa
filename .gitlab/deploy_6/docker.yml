---
# FIXME: our current Gitlab version doesn't support importing a file more than once
# For now, the workaround is to include "common" files once in the top-level .gitlab-ci.yml file
# See: https://gitlab.com/gitlab-org/gitlab/-/issues/28987
# include:
#   - /.gitlab/docker_common/tag_job_templates.yml

.if_deploy_on_tag_6: &if_deploy_on_tag_6
  # no RELEASE_VERSION means a nightly build for omnibus
  if: $DEPLOY_AGENT == "true" && $RELEASE_VERSION_6 != "nightly" && $RELEASE_VERSION_6 != ""

.if_deploy_6: &if_deploy_6
  if: $DEPLOY_AGENT == "true" && $RELEASE_VERSION_6 != ""

.if_not_master_branch: &if_not_master_branch
  if: $CI_COMMIT_BRANCH != "master"

deploy_docker-6-prod:
  stage: deploy6
  rules:
    - <<: *if_deploy_on_tag_6
  trigger:
    include:
      - local: /.gitlab/deploy_6/child_pipelines/docker.yml
  variables:
    # Override SRC_TAG in order to not use the child pipeline's pipeline id
    SRC_TAG: v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}
    AGENT_DH_REPOSITORY: datadog/agent
    AGENT_GCR_REPOSITORY: gcr.io/datadoghq/agent

deploy_docker-6-dev:
  stage: deploy6
  rules:
    - <<: *if_deploy_on_tag_6
      when: never
    - <<: *if_deploy_6
  trigger:
    include:
      - local: /.gitlab/deploy_6/child_pipelines/docker.yml
  variables:
    # Override SRC_TAG in order to not use the child pipeline's pipeline id
    SRC_TAG: v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}
    AGENT_DH_REPOSITORY: datadog/agent-dev
    AGENT_GCR_REPOSITORY: gcr.io/datadoghq/agent-dev